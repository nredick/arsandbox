/***********************************************************************
InterFrameCompressor - Class to compress the difference between two
bathymetry or water level grids.
Copyright (c) 2023 Oliver Kreylos

This file is part of the Augmented Reality Sandbox (SARndbox).

The Augmented Reality Sandbox is free software; you can redistribute it
and/or modify it under the terms of the GNU General Public License as
published by the Free Software Foundation; either version 2 of the
License, or (at your option) any later version.

The Augmented Reality Sandbox is distributed in the hope that it will be
useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
General Public License for more details.

You should have received a copy of the GNU General Public License along
with the Augmented Reality Sandbox; if not, write to the Free Software
Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
***********************************************************************/

#include "InterFrameCompressor.h"

#include "HuffmanBuilder.h"

namespace {

/********************************************************
Huffman encoding codebook for the inter-frame compressor:
********************************************************/

static const HuffmanBuilder::Code interFrameCompressorCodebook[]=
	{
	{0x3c376U,19},{0x2d148U,19},{0x2d149U,19},{0x26721U,19},{0x24f52U,19},{0x22718U,19},{0x24912U,19},{0x22719U,19},
	{0x3cdf7U,18},{0x3ccdcU,18},{0x3ef3bU,18},{0x3c24dU,18},{0x3cdf6U,18},{0x3b7cbU,18},{0x3ca5eU,18},{0x37a2aU,18},
	{0x3994dU,18},{0x35a5bU,18},{0x3732aU,18},{0x34cf9U,18},{0x333d8U,18},{0x32c73U,18},{0x332b0U,18},{0x34cf8U,18},
	{0x333d2U,18},{0x32c72U,18},{0x1fbd7U,18},{0x1fbd6U,18},{0x1ee17U,18},{0x1e4a7U,18},{0x1ef8aU,18},{0x1efd4U,18},
	{0x17730U,18},{0x17737U,18},{0x16df8U,18},{0x1ee16U,18},{0x168a5U,18},{0x13208U,18},{0x12a63U,18},{0x1139eU,18},
	{0x127aeU,18},{0x1311fU,18},{0x115cbU,18},{0x11384U,18},{0x110a4U,18},{0x1fdafU,17},{0x1e6f3U,17},{0x1e66fU,17},
	{0x1e52eU,17},{0x1e125U,17},{0x1dbe4U,17},{0x1cc9bU,17},{0x1b994U,17},{0x1b906U,17},{0x1a2bbU,17},{0x1a60fU,17},
	{0x19687U,17},{0x1957fU,17},{0x196b9U,17},{0x19569U,17},{0x18cc3U,17},{0x0fde9U,17},{0x0f732U,17},{0x0f25cU,17},
	{0x0f7c4U,17},{0x0f70aU,17},{0x0bbcaU,17},{0x0f0dcU,17},{0x0b453U,17},{0x09b83U,17},{0x09bbdU,17},{0x09bafU,17},
	{0x09b82U,17},{0x09522U,17},{0x09246U,17},{0x09245U,17},{0x09523U,17},{0x089c7U,17},{0x089c3U,17},{0x089e5U,17},
	{0xfba8U,16},{0xf296U,16},{0xf303U,16},{0xed90U,16},{0xe703U,16},{0xde8bU,16},{0xe64cU,16},{0xd6baU,16},
	{0xd33fU,16},{0xd338U,16},{0xd33aU,16},{0xccf7U,16},{0xccadU,16},{0xcc2cU,16},{0xcab1U,16},{0xcb42U,16},
	{0xc66aU,16},{0x7ee1U,16},{0x7ed1U,16},{0x7e84U,16},{0x7baaU,16},{0x792fU,16},{0x5b77U,16},{0x5b7bU,16},
	{0x7862U,16},{0x5a42U,16},{0x4dd6U,16},{0x4ddcU,16},{0x4c80U,16},{0x4977U,16},{0x49ecU,16},{0x49dcU,16},
	{0x44e6U,16},{0x4483U,16},{0x7de6U,15},{0x7948U,15},{0x7870U,15},{0x7848U,15},{0x76c1U,15},{0x76c0U,15},
	{0x73d2U,15},{0x7327U,15},{0x7380U,15},{0x6f30U,15},{0x6e51U,15},{0x6ef4U,15},{0x6b4dU,15},{0x69b2U,15},
	{0x685fU,15},{0x6649U,15},{0x65a8U,15},{0x6334U,15},{0x62e2U,15},{0x62e1U,15},{0x3f0bU,15},{0x3dfbU,15},
	{0x3dd7U,15},{0x3cceU,15},{0x3c3cU,15},{0x2ef3U,15},{0x2ee3U,15},{0x2dbaU,15},{0x2d15U,15},{0x26ecU,15},
	{0x2649U,15},{0x2575U,15},{0x2549U,15},{0x24efU,15},{0x2272U,15},{0x2243U,15},{0x3fb7U,14},{0x3ee9U,14},
	{0x3ef2U,14},{0x3ec4U,14},{0x3cc1U,14},{0x3ca6U,14},{0x3c25U,14},{0x3b63U,14},{0x3995U,14},{0x379bU,14},
	{0x3731U,14},{0x3737U,14},{0x3730U,14},{0x34daU,14},{0x34d8U,14},{0x3429U,14},{0x333bU,14},{0x333aU,14},
	{0x3304U,14},{0x3297U,14},{0x3197U,14},{0x1fbcU,14},{0x1fb9U,14},{0x1f84U,14},{0x1ee5U,14},{0x1e64U,14},
	{0x1e19U,14},{0x16dcU,14},{0x1683U,14},{0x1336U,14},{0x1371U,14},{0x1321U,14},{0x1310U,14},{0x12a0U,14},
	{0x1276U,14},{0x1259U,14},{0x115dU,14},{0x1124U,14},{0x110dU,14},{0x1fd3U,13},{0x1f60U,13},{0x1e61U,13},
	{0x1dbfU,13},{0x1cf9U,13},{0x1cf8U,13},{0x1bceU,13},{0x1b9aU,13},{0x1b91U,13},{0x1ad0U,13},{0x1acdU,13},
	{0x1a61U,13},{0x1a16U,13},{0x1a12U,13},{0x199fU,13},{0x1987U,13},{0x1983U,13},{0x1954U,13},{0x18caU,13},
	{0x0fddU,13},{0x0f7fU,13},{0x0f7bU,13},{0x0f71U,13},{0x0f27U,13},{0x0f0eU,13},{0x0bbbU,13},{0x0b7bU,13},
	{0x0b49U,13},{0x0b44U,13},{0x099dU,13},{0x0991U,13},{0x095cU,13},{0x093cU,13},{0x092dU,13},{0x089fU,13},
	{0x0891U,13},{0xfe8U,12},{0xfbbU,12},{0xf32U,12},{0xf0fU,12},{0xedcU,12},{0xe7bU,12},{0xde9U,12},
	{0xddfU,12},{0xdc9U,12},{0xd32U,12},{0xd08U,12},{0xcb0U,12},{0xc64U,12},{0x7e0U,12},{0x791U,12},
	{0x5a1U,12},{0x4afU,12},{0x491U,12},{0x7dfU,11},{0x786U,11},{0x731U,11},{0x68bU,11},{0x62fU,11},
	{0x2d3U,11},{0x225U,11},{0x378U,10},{0x1e5U,10},{0x1a3U,9},{0x58U,8},{0x38U,6},{0x2U,2},
	{0x3fb5cbU,22},{0x0U,2},{0x0aU,5},{0x3aU,6},{0x7fU,8},{0x0baU,9},{0x1b8U,9},{0x111U,10},
	{0x16eU,10},{0x328U,10},{0x35bU,10},{0x3c0U,10},{0x226U,11},{0x263U,11},{0x2dfU,11},{0x3f5U,11},
	{0x659U,11},{0x69aU,11},{0x6f2U,11},{0x73fU,11},{0x795U,11},{0x7f5U,11},{0x490U,12},{0x4acU,12},
	{0x4cfU,12},{0x5bcU,12},{0x790U,12},{0x7bcU,12},{0xc5aU,12},{0xca9U,12},{0xcc8U,12},{0xd0cU,12},
	{0xd67U,12},{0xdcbU,12},{0xe61U,12},{0xe71U,12},{0xeddU,12},{0xf31U,12},{0xfb2U,12},{0xfecU,12},
	{0x0893U,13},{0x0925U,13},{0x0939U,13},{0x095bU,13},{0x099aU,13},{0x0b40U,13},{0x0bbaU,13},{0x0f26U,13},
	{0x0f7dU,13},{0x0fd8U,13},{0x18ceU,13},{0x194aU,13},{0x1986U,13},{0x1a15U,13},{0x1a28U,13},{0x1a6fU,13},
	{0x1ad6U,13},{0x1bbcU,13},{0x1cc8U,13},{0x1cf1U,13},{0x1e10U,13},{0x1e6eU,13},{0x1f7bU,13},{0x110cU,14},
	{0x1274U,14},{0x12a7U,14},{0x1338U,14},{0x1696U,14},{0x1770U,14},{0x1e65U,14},{0x1ef4U,14},{0x1fb5U,14},
	{0x319bU,14},{0x32c6U,14},{0x3339U,14},{0x3453U,14},{0x35a3U,14},{0x3733U,14},{0x3736U,14},{0x399eU,14},
	{0x39c2U,14},{0x3b61U,14},{0x3b62U,14},{0x3cceU,14},{0x3ec6U,14},{0x2240U,15},{0x22b8U,15},{0x2274U,15},
	{0x24e2U,15},{0x2543U,15},{0x2624U,15},{0x26edU,15},{0x2d2fU,15},{0x2ee7U,15},{0x3c3dU,15},{0x3debU,15},
	{0x3f43U,15},{0x3f7dU,15},{0x62daU,15},{0x655eU,15},{0x6612U,15},{0x65adU,15},{0x6851U,15},{0x6982U,15},
	{0x6e40U,15},{0x6f35U,15},{0x6f47U,15},{0x73c2U,15},{0x794aU,15},{0x7980U,15},{0x7998U,15},{0x7d8eU,15},
	{0x7f4aU,15},{0x44eaU,16},{0x44e0U,16},{0x4573U,16},{0x4ae8U,16},{0x4cdfU,16},{0x4dc0U,16},{0x5a5dU,16},
	{0x792dU,16},{0x7b80U,16},{0x7babU,16},{0xcb15U,16},{0xca4eU,16},{0xcab5U,16},{0xd0b8U,16},{0xd15cU,16},
	{0xd367U,16},{0xd697U,16},{0xe70cU,16},{0xe706U,16},{0xe70dU,16},{0xed91U,16},{0xe799U,16},{0xedf3U,16},
	{0xfbcfU,16},{0xfb15U,16},{0x089e4U,17},{0x099bcU,17},{0x09530U,17},{0x0b6edU,17},{0x0bb9aU,17},{0x0f703U,17},
	{0x0f25dU,17},{0x0f7ebU,17},{0x19686U,17},{0x1a60dU,17},{0x1a175U,17},{0x1bd14U,17},{0x1cca7U,17},{0x1e110U,17},
	{0x1e124U,17},{0x1e6f2U,17},{0x1f79cU,17},{0x110a5U,18},{0x115caU,18},{0x127beU,18},{0x1248fU,18},{0x13209U,18},
	{0x13779U,18},{0x16970U,18},{0x168a3U,18},{0x13778U,18},{0x12a62U,18},{0x13776U,18},{0x1e4a6U,18},{0x1ef8bU,18},
	{0x1e1baU,18},{0x1ee60U,18},{0x1fa17U,18},{0x31707U,18},{0x332b1U,18},{0x32afdU,18},{0x32927U,18},{0x32afcU,18},
	{0x32c50U,18},{0x342ecU,18},{0x333d9U,18},{0x32c51U,18},{0x3598dU,18},{0x34cfbU,18},{0x35a5aU,18},{0x37a2bU,18},
	{0x3994cU,18},{0x3b7caU,18},{0x3cde0U,18},{0x3cde1U,18},{0x3fb5dU,18},{0x3ccddU,18},{0x24913U,19},{0x2279fU,19},
	{0x26722U,19},{0x2dbf3U,19},{0x3f7a0U,19},{0x6524cU,19},{0x6b318U,19},{0x699f5U,19},{0x685dbU,19},{0x6e657U,19},
	{0x73d33U,19},{0x794bfU,19},{0x7de75U,19},{0x794beU,19},{0x73d31U,19},{0x78499U,19},{0x49ea6U,20},{0x49ea7U,20},
	{0x5b7e4U,20},{0x4ce47U,20},{0x4ce46U,20},{0x786eeU,20},{0xccf4eU,20},{0x7ef43U,20},{0xccf4dU,20},{0xd33e8U,20},
	{0xca49bU,20},{0xd6633U,20},{0xca49aU,20},{0xe7a60U,20},{0xccf4fU,20},{0xd0bb5U,20},{0xd6632U,20},{0xccf4cU,20},
	{0xd33e9U,20},{0xf0930U,20},{0xdccacU,20},{0xfed73U,20},{0xfbce9U,20},{0xe7a61U,20},{0x089e79U,21},{0xfed70U,20},
	{0x0b6fcaU,21},{0xe7a65U,20},{0xf0931U,20},{0x099c82U,21},{0xfbce8U,20},{0xfed71U,20},{0x089e7aU,21},{0x099c83U,21},
	{0x099c80U,21},{0x089e7bU,21},{0x089e78U,21},{0x0f0ddeU,21},{0x099c81U,21},{0x0f0ddfU,21},{0x0fde84U,21},{0x0b6fcbU,21},
	{0x1a1768U,21},{0x1b995bU,21},{0x0fde85U,21},{0x1cf4c8U,21},{0x1cf4c9U,21},{0x1fdae4U,21},{0x1b995aU,21},{0x1a1769U,21},
	{0x3fb5caU,22},{0x1955U,13},{0x6U,4},{0x0eU,5},{0x10U,6},{0x30U,6},{0x36U,6},{0x3dU,6},
	{0x23U,7},{0x27U,7},{0x2fU,7},{0x3eU,7},{0x64U,7},{0x67U,7},{0x6aU,7},{0x72U,7},
	{0x77U,7},{0x7cU,7},{0x7eU,7},{0x48U,8},{0x4bU,8},{0x59U,8},{0x5cU,8},{0x7aU,8},
	{0xc4U,8},{0xc7U,8},{0xcdU,8},{0xd2U,8},{0xd7U,8},{0xdfU,8},{0xecU,8},{0xf1U,8},
	{0xfaU,8},{0xffU,8},{0x08bU,9},{0x094U,9},{0x09aU,9},{0x0b5U,9},{0x0f1U,9},{0x0f6U,9},
	{0x18aU,9},{0x18dU,9},{0x197U,9},{0x1a0U,9},{0x1a7U,9},{0x1baU,9},{0x1cdU,9},{0x1daU,9},
	{0x1e4U,9},{0x1e7U,9},{0x1fcU,9},{0x114U,10},{0x126U,10},{0x130U,10},{0x136U,10},{0x16cU,10},
	{0x1e0U,10},{0x1e7U,10},{0x1f9U,10},{0x318U,10},{0x32bU,10},{0x331U,10},{0x344U,10},{0x358U,10},
	{0x376U,10},{0x37bU,10},{0x39dU,10},{0x3c1U,10},{0x3cbU,10},{0x3edU,10},{0x220U,11},{0x22aU,11},
	{0x24aU,11},{0x255U,11},{0x265U,11},{0x26fU,11},{0x2daU,11},{0x3c2U,11},{0x3cdU,11},{0x3f1U,11},
	{0x62cU,11},{0x653U,11},{0x65bU,11},{0x666U,11},{0x687U,11},{0x6b2U,11},{0x6e7U,11},{0x6f5U,11},
	{0x739U,11},{0x76dU,11},{0x785U,11},{0x79aU,11},{0x7dcU,11},{0x7f7U,11},{0x456U,12},{0x493U,12},
	{0x49fU,12},{0x4c5U,12},{0x4ccU,12},{0x5a3U,12},{0x5b6U,12},{0x5dfU,12},{0x798U,12},{0x7bbU,12},
	{0x7e9U,12},{0xc5dU,12},{0xca8U,12},{0xcc0U,12},{0xccbU,12},{0xd0dU,12},{0xd31U,12},{0xd6aU,12},
	{0xdddU,12},{0xe60U,12},{0xe66U,12},{0xe7dU,12},{0xedeU,12},{0xf28U,12},{0xf36U,12},{0xfb3U,12},
	{0x0884U,13},{0x0887U,13},{0x08afU,13},{0x092fU,13},{0x0951U,13},{0x095aU,13},{0x0993U,13},{0x09b9U,13},
	{0x0b4aU,13},{0x0b7aU,13},{0x0bbdU,13},{0x0f24U,13},{0x0f74U,13},{0x0fc3U,13},{0x0fd9U,13},{0x18b9U,13},
	{0x1948U,13},{0x1969U,13},{0x1993U,13},{0x1994U,13},{0x1a13U,13},{0x1a2aU,13},{0x1a66U,13},{0x1a6eU,13},
	{0x1bb8U,13},{0x1bb9U,13},{0x1bcfU,13},{0x1ccbU,13},{0x1cf2U,13},{0x1cf5U,13},{0x1db3U,13},{0x1e13U,13},
	{0x1e1dU,13},{0x1f61U,13},{0x1f78U,13},{0x1f7aU,13},{0x110bU,14},{0x1125U,14},{0x113bU,14},{0x1249U,14},
	{0x1275U,14},{0x1270U,14},{0x12a5U,14},{0x12bbU,14},{0x1313U,14},{0x1325U,14},{0x1374U,14},{0x168bU,14},
	{0x1691U,14},{0x1772U,14},{0x1e1aU,14},{0x1e1fU,14},{0x1e66U,14},{0x1ef9U,14},{0x1efcU,14},{0x1fa2U,14},
	{0x1fbfU,14},{0x316fU,14},{0x319fU,14},{0x32aeU,14},{0x32d5U,14},{0x32d1U,14},{0x3338U,14},{0x333cU,14},
	{0x3452U,14},{0x34c0U,14},{0x3456U,14},{0x34dbU,14},{0x35afU,14},{0x372aU,14},{0x3799U,14},{0x3729U,14},
	{0x377bU,14},{0x37a1U,14},{0x3992U,14},{0x399cU,14},{0x399fU,14},{0x39e0U,14},{0x39e7U,14},{0x39e8U,14},
	{0x3b65U,14},{0x3b7dU,14},{0x3c23U,14},{0x3c39U,14},{0x3ca7U,14},{0x3ccfU,14},{0x3fa4U,14},{0x3ee8U,14},
	{0x3eebU,14},{0x2215U,15},{0x3fb6U,14},{0x3fb4U,14},{0x2278U,15},{0x2242U,15},{0x24b8U,15},{0x227bU,15},
	{0x24baU,15},{0x227aU,15},{0x2490U,15},{0x24b0U,15},{0x24e3U,15},{0x24b1U,15},{0x2542U,15},{0x24f4U,15},
	{0x254dU,15},{0x2622U,15},{0x2648U,15},{0x2625U,15},{0x2673U,15},{0x266eU,15},{0x2d04U,15},{0x2d05U,15},
	{0x26e1U,15},{0x2d20U,15},{0x26eaU,15},{0x2dbcU,15},{0x2ee2U,15},{0x2dbeU,15},{0x3c36U,15},{0x3c30U,15},
	{0x2ef0U,15},{0x3dc3U,15},{0x2ef1U,15},{0x3dcdU,15},{0x3c95U,15},{0x3dc8U,15},{0x3ccfU,15},{0x3deaU,15},
	{0x3dc9U,15},{0x3dc1U,15},{0x3df0U,15},{0x3dd6U,15},{0x3f40U,15},{0x3dd4U,15},{0x3dcfU,15},{0x3dceU,15},
	{0x3f46U,15},{0x3f7bU,15},{0x3f41U,15},{0x3f6eU,15},{0x62dcU,15},{0x3f0aU,15},{0x3f47U,15},{0x3f6dU,15},
	{0x3f6cU,15},{0x3f71U,15},{0x3f69U,15},{0x632cU,15},{0x6331U,15},{0x62dbU,15},{0x3f6fU,15},{0x62e3U,15},
	{0x62d8U,15},{0x6526U,15},{0x6333U,15},{0x62ddU,15},{0x6332U,15},{0x3f7cU,15},{0x632dU,15},{0x633cU,15},
	{0x655bU,15},{0x633dU,15},{0x652cU,15},{0x6559U,15},{0x658fU,15},{0x652dU,15},{0x65a9U,15},{0x658bU,15},
	{0x6589U,15},{0x660aU,15},{0x65acU,15},{0x65afU,15},{0x6588U,15},{0x664aU,15},{0x6648U,15},{0x6655U,15},
	{0x660bU,15},{0x6614U,15},{0x6610U,15},{0x6615U,15},{0x6611U,15},{0x6613U,15},{0x6657U,15},{0x65a0U,15},
	{0x6654U,15},{0x6617U,15},{0x685eU,15},{0x699eU,15},{0x6b4eU,15},{0x6b44U,15},{0x6b45U,15},{0x68afU,15},
	{0x6b49U,15},{0x6b32U,15},{0x6b4cU,15},{0x6b30U,15},{0x6b48U,15},{0x6b33U,15},{0x6b4aU,15},{0x6b5cU,15},
	{0x6e42U,15},{0x6e56U,15},{0x6b4fU,15},{0x6f34U,15},{0x6e57U,15},{0x6ef5U,15},{0x6e43U,15},{0x6f31U,15},
	{0x6f41U,15},{0x6e64U,15},{0x6f44U,15},{0x6f46U,15},{0x7328U,15},{0x733bU,15},{0x76f8U,15},{0x73c3U,15},
	{0x73cdU,15},{0x733aU,15},{0x7387U,15},{0x7382U,15},{0x7871U,15},{0x76c9U,15},{0x799aU,15},{0x7845U,15},
	{0x79bdU,15},{0x7999U,15},{0x7dd5U,15},{0x7d8bU,15},{0x79bfU,15},{0x4428U,16},{0x7f4bU,15},{0x7f6aU,15},
	{0x4482U,16},{0x44e2U,16},{0x44ebU,16},{0x4972U,16},{0x4973U,16},{0x4a99U,16},{0x49ddU,16},{0x49edU,16},
	{0x49eeU,16},{0x4a90U,16},{0x4c46U,16},{0x4c81U,16},{0x4ae9U,16},{0x4ce5U,16},{0x4c83U,16},{0x4ddfU,16},
	{0x5a43U,16},{0x5b7aU,16},{0x5de4U,16},{0x7928U,16},{0x7863U,16},{0x792cU,16},{0x786fU,16},{0x7b84U,16},
	{0x7be3U,16},{0x7ed0U,16},{0x7bf4U,16},{0xca48U,16},{0xc5c0U,16},{0xc5b3U,16},{0xca4fU,16},{0xc66bU,16},
	{0xc5b2U,16},{0xcabeU,16},{0xca4bU,16},{0xca4aU,16},{0xc660U,16},{0xcab0U,16},{0xcc97U,16},{0xcb1dU,16},
	{0xd0b9U,16},{0xccf5U,16},{0xd0a0U,16},{0xd339U,16},{0xd33bU,16},{0xd366U,16},{0xdccbU,16},{0xd6bbU,16},
	{0xde81U,16},{0xdc82U,16},{0xde80U,16},{0xdca0U,16},{0xe652U,16},{0xe702U,16},{0xe798U,16},{0xf293U,16},
	{0xf089U,16},{0xf292U,16},{0xf302U,16},{0xfb1eU,16},{0xf336U,16},{0xfb1fU,16},{0xfb14U,16},{0xfba9U,16},
	{0xf37cU,16},{0xfed6U,16},{0x089e6U,17},{0x089ceU,17},{0x08ae4U,17},{0x092edU,17},{0x093deU,17},{0x092ecU,17},
	{0x099bdU,17},{0x093d5U,17},{0x093d6U,17},{0x099c9U,17},{0x09905U,17},{0x09baeU,17},{0x09bbaU,17},{0x0b6ecU,17},
	{0x0b6fdU,17},{0x0b4b9U,17},{0x0b450U,17},{0x0bbcbU,17},{0x0b6feU,17},{0x0b6ffU,17},{0x0bb99U,17},{0x0f731U,17},
	{0x0fdc0U,17},{0x0fd0aU,17},{0x0fdc1U,17},{0x0f733U,17},{0x0fdeaU,17},{0x18b82U,17},{0x19492U,17},{0x18cc2U,17},
	{0x19629U,17},{0x196baU,17},{0x199e8U,17},{0x196bbU,17},{0x1992cU,17},{0x19568U,17},{0x19638U,17},{0x19959U,17},
	{0x1a143U,17},{0x1a142U,17},{0x1992dU,17},{0x1a177U,17},{0x1985bU,17},{0x1a174U,17},{0x1985aU,17},{0x196b8U,17},
	{0x199edU,17},{0x1a2baU,17},{0x1acc5U,17},{0x1ad2cU,17},{0x1b943U,17},{0x1b907U,17},{0x1acc4U,17},{0x1a60eU,17},
	{0x1acc7U,17},{0x1a60cU,17},{0x1cc9aU,17},{0x1b942U,17},{0x1ce0eU,17},{0x1ce0fU,17},{0x1e111U,17},{0x1cf4dU,17},
	{0x1e6faU,17},{0x1cf4fU,17},{0x1cf4eU,17},{0x1e6f1U,17},{0x1e127U,17},{0x11385U,18},{0x110a7U,18},{0x110a6U,18},
	{0x113ceU,18},{0x1138dU,18},{0x1139fU,18},{0x1248eU,18},{0x12488U,18},{0x127bfU,18},{0x127afU,18},{0x1311eU,18},
	{0x1311dU,18},{0x1311cU,18},{0x16971U,18},{0x127a8U,18},{0x13777U,18},{0x168a2U,18},{0x1e4a4U,18},{0x17731U,18},
	{0x1e4a5U,18},{0x17736U,18},{0x1ee61U,18},{0x1ee04U,18},{0x1ee05U,18},{0x1fa16U,18},{0x1efd5U,18},{0x1fbd1U,18},
	{0x31706U,18},{0x176U,10}
	};

}

/*************************************
Methods of class InterFrameCompressor:
*************************************/

InterFrameCompressor::InterFrameCompressor(IO::File& sFile)
	:file(&sFile),
	 encoder(sFile,interFrameCompressorCodebook),
	 zeroRunLength(0)
	{
	}

void InterFrameCompressor::compressFrame(unsigned int width,unsigned int height,const Pixel* pixels0,const Pixel* pixels1)
	{
	/* Encode all pixel differences: */
	const Pixel* p0Ptr=pixels0;
	const Pixel* p1Ptr=pixels1;
	const Pixel* p1End=pixels1+(height*width);
	for(;p1Ptr!=p1End;++p0Ptr,++p1Ptr)
		{
		Pixel delta=*p1Ptr-*p0Ptr;
		
		/* Check for runs of zero deltas: */
		if(delta==0U)
			{
			/* Increase the current zero run length: */
			++zeroRunLength;
			
			/* Finish the current zero run if it has reached maximum length: */
			if(zeroRunLength==maxZeroRunLength)
				finishZeroRun();
			}
		else
			{
			/* Finish a potential zero run: */
			if(zeroRunLength!=0U)
				finishZeroRun();
			
			if(delta>=65536U-codeMax) // Negative in-range delta
				encoder.encode(delta-(65536U-codeMax));
			else if(delta<=codeMax) // Positive in-range delta
				encoder.encode(delta+codeMax);
			else // Out-of-range delta
				{
				/* Write the out-of-range marker followed by the out-of-range delta as-is: */
				encoder.encode(outOfRange);
				encoder.writeBits(delta,sizeof(Pixel)*8U);
				}
			}
		}
	
	/* Finish a potential zero run: */
	if(zeroRunLength>0U)
		finishZeroRun();
	
	/* Flush the encoder: */
	encoder.flush();
	}
